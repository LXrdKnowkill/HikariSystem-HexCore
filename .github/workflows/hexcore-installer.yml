name: HexCore Build Installer

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"

permissions:
  contents: write

env:
  VSCODE_SKIP_NODE_VERSION_CHECK: 1

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          npm install -g node-gyp
          npm install -g gulp-cli
          npm install -g tsx

      - name: Install dependencies
        run: npm ci --ignore-scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile HexCore Extensions
        run: |
          cd extensions/hexcore-hexviewer && npm ci && npm run compile
          cd ../hexcore-peanalyzer && npm ci && npm run compile
          cd ../hexcore-hashcalc && npm ci && npm run compile
          cd ../hexcore-strings && npm ci && npm run compile
          cd ../hexcore-entropy && npm ci && npm run compile
          cd ../hexcore-base64 && npm ci && npm run compile
          cd ../hexcore-filetype && npm ci && npm run compile
          cd ../hexcore-common && npm ci && npm run compile

      - name: Build VS Code
        run: npm run gulp vscode-win32-x64-min
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path ".build/win32-x64/VSCode-win32-x64/*" -DestinationPath "HexCore-win32-x64.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: HexCore-win32-x64
          path: HexCore-win32-x64.zip

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: HexCore-win32-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev

      - name: Install build tools
        run: |
          npm install -g node-gyp
          npm install -g gulp-cli
          npm install -g tsx

      - name: Install dependencies
        run: npm ci --ignore-scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Compile HexCore Extensions
        run: |
          cd extensions/hexcore-hexviewer && npm ci && npm run compile
          cd ../hexcore-peanalyzer && npm ci && npm run compile
          cd ../hexcore-hashcalc && npm ci && npm run compile
          cd ../hexcore-strings && npm ci && npm run compile
          cd ../hexcore-entropy && npm ci && npm run compile
          cd ../hexcore-base64 && npm ci && npm run compile
          cd ../hexcore-filetype && npm ci && npm run compile
          cd ../hexcore-common && npm ci && npm run compile

      - name: Build VS Code
        run: npm run gulp vscode-linux-x64-min
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create TAR.GZ archive
        run: |
          cd .build/linux-x64
          tar -czvf ../../HexCore-linux-x64.tar.gz VSCode-linux-x64

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: HexCore-linux-x64
          path: HexCore-linux-x64.tar.gz

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: HexCore-linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
